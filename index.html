<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Red Square WebGL</title>
<style>
  body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
  canvas { width: 100%; height: 100%; display: block; }
</style>
</head>
<body>
<canvas id="glcanvas"></canvas>

<script>
// ---------------------------------------------------------
// Camera State
// ---------------------------------------------------------
let camX = 0, camY = 0;
let zoom = 1;
  
// Image state
let imgWidth = 1, imgHeight = 1;
  
// --------------------------
// Orthographic Projection
// --------------------------
function ortho(left, right, bottom, top, near, far) {
  return new Float32Array([
    2/(right-left), 0, 0, 0,
    0, 2/(top-bottom), 0, 0,
    0, 0, -2/(far-near), 0,
    -(right+left)/(right-left),
    -(top+bottom)/(top-bottom),
    -(far+near)/(far-near),
    1
  ]);
}
  
// -------------------- SHADERS --------------------
const vsSource = `
attribute vec2 aPos;
attribute vec2 aTex;
uniform mat4 u_proj;
varying vec2 vTex;

void main() {
    gl_Position = u_proj * vec4(aPos, 0.0, 1.0);
    vTex = aTex;
}
`;

const fsSource = `
precision mediump float;
varying vec2 vTex;
uniform sampler2D uTex;
void main() {
    gl_FragColor = texture2D(uTex, vTex);
}
`;

// -------------------- INIT WEBGL --------------------
const canvas = document.getElementById("glcanvas");
const gl = canvas.getContext("webgl");
if (!gl) alert("WebGL not supported");

function compileShader(type, source) {
    const shader = gl.createShader(type);
    gl.shaderSource(shader, source);
    gl.compileShader(shader);
    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
        console.error(gl.getShaderInfoLog(shader));
        return null;
    }
    return shader;
}

const vs = compileShader(gl.VERTEX_SHADER, vsSource);
const fs = compileShader(gl.FRAGMENT_SHADER, fsSource);

const program = gl.createProgram();
gl.attachShader(program, vs);
gl.attachShader(program, fs);
gl.linkProgram(program);
gl.useProgram(program);

const u_proj = gl.getUniformLocation(program, "u_proj");
 
function createImageBuffer(){
  // -------------------- RECTANGLE GEOMETRY --------------------
  // Full-screen rectangle (-1 to +1)
  const vertices = new Float32Array([
    //  X,   Y,   U,  V
    0,        imgHeight,  0,  0,  // bottom-left
    imgWidth, imgHeight,  1,  0,  // bottom-right
    imgWidth, 0,          1,  1,  // top-right
    0,        0,          0,  1   // top-left
  ]);
  
  const indices = new Uint16Array([
    3, 2, 0,
    0, 1, 2
  ]);
  
  // ---- VBO ----
  const buffer = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
  gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);

  // ---- EBO (Index Buffer) ----
  const ibo = gl.createBuffer();
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibo);
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW);

  const aPos = gl.getAttribLocation(program, "aPos");
  const aTex = gl.getAttribLocation(program, "aTex");
  const uTex = gl.getUniformLocation(program, "uTex");
  
  gl.enableVertexAttribArray(aPos);
  gl.vertexAttribPointer(aPos, 2, gl.FLOAT, false, 16, 0);

  gl.enableVertexAttribArray(aTex);
  gl.vertexAttribPointer(aTex, 2, gl.FLOAT, false, 16, 8);

  gl.uniform1i(uTex, 0); // bind texture unit 0
}

function loadImageToTexture(image){
    const tex = gl.createTexture();
    gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D, tex);
    
    gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);

    const err = gl.getError();
    console.log("GL ERROR after texImage2D:", err);
  
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
}
// -------------------- LOAD IMAGE --------------------
const image = new Image();
image.src = "http://192.168.1.35:8080/img.jpg";  // ← your image
image.onload = () => {
    console.log("IMAGE LOADED");
    imgHeight = image.height;
    imgWidth = image.width;
  
    createImageBuffer();
    loadImageToTexture(image);
};

function resetViewToFit() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  gl.viewport(0, 0, canvas.width, canvas.height);
  
  const screenW = canvas.clientWidth;
  const screenH = canvas.clientHeight;

  // Fit image inside screen
  zoom = Math.min(screenW / imgWidth, screenH / imgHeight);

  // Compute how large the ortho window will become
  const viewW = screenW / zoom;
  const viewH = screenH / zoom;

  // Center camera so image is perfectly centered
  camX = (imgWidth  - viewW) / 2;
  camY = (imgHeight - viewH) / 2;
}

// -------------------- DRAW --------------------
function draw() {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    gl.viewport(0, 0, canvas.width, canvas.height);
    
    let w = canvas.width / zoom;
    let h = canvas.height / zoom;

    let left = camX;
    let right = camX + w;
    let bottom = camY;
    let top = camY + h;
  
    const proj = ortho(left, right, bottom, top, -1, 1);
    gl.uniformMatrix4fv(u_proj, false, proj);
  
    gl.clearColor(0, 0, 0, 1);
    gl.clear(gl.COLOR_BUFFER_BIT);

    //gl.drawArrays(gl.TRIANGLE_STRIP, 0, 6);
    gl.drawElements(gl.TRIANGLES, 6, gl.UNSIGNED_SHORT, 0);
    console.log("draw");
}
  
function init() {
    resetViewToFit();
    draw();           // ✓ draw first frame
}
  
window.onload = init;
</script>
</body>
</html>